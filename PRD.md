# Feishu CLI Proxy PRD

**产品名称**
Feishu CLI Proxy（本地代理 + 飞书双机器人）

**背景**
开发者在本地使用 `codex` / `claude code` 进行任务执行时，需要在飞书中远程沟通与过程推送；同时希望本地使用无感，并支持按需开启代理/推送。

**目标**
1. 通过 `feishu run ...` 启动 CLI 会话并可被代理接管。
2. 支持”对话型双向机器人”与”过程推送机器人”分工。
3. 可视化窗口展示会话列表，按需开启代理与推送。
4. 任务结束时发送最后总结给双向机器人。

**非目标**
1. 不中途接管由用户手动启动的 CLI 会话。
2. 不实现多会话同时绑定同一个双向机器人。
3. 不提供飞书端流式输出（仅多条消息推送）。

**用户画像**
1. 开发者/技术负责人，需要远程跟踪与对话本地 CLI 任务。
2. 需要将执行过程输出实时推送给团队或自己。

**核心场景**
1. 本地启动 `feishu run claude ...` 进行任务。
2. GUI 显示监听到的会话。
3. 选择会话，绑定双向机器人，开启代理。
4. 可选绑定推送机器人，开启过程输出推送。
5. 任务结束后自动发送总结给双向机器人。

**功能需求**
1. 会话启动
1.1 命令行 `feishu run <cli> [args...]` 启动会话。
1.2 CLI 进程通过 PTY 启动子进程并持有 PTY，保证本地交互体验无感。
1.3 CLI 进程将 PTY 输出流转发给 Daemon，同时接收 Daemon 转发的飞书输入写入 PTY stdin。
1.4 关闭终端窗口 = CLI 进程退出 = PTY 子进程退出 = 会话结束。
2. 会话列表与管理
2.1 GUI 显示监听中的会话列表。
2.2 会话支持绑定/解绑双向机器人。
2.3 会话支持启用/关闭推送机器人。
3. 消息路由
3.1 飞书输入只走双向机器人，写入会话 stdin。
3.2 过程输出（stdout/工具调用/错误/警告）发送推送机器人（可选）。
3.3 任务结束总结仅发送双向机器人。
4. 机器人配置
4.1 GUI 支持配置多个双向机器人。
4.2 GUI 支持配置多个推送机器人。
4.3 双向机器人必选，推送机器人可选。
4.4 一个推送机器人允许绑定多个会话（消息中携带会话标识以区分）。
5. 任务结束判定与总结
5.1 优先基于 CLI 退出事件（PTY 子进程 exit）判定完成，辅助 Claude Code hooks 增强。
5.2 复用 CLI 最后输出作为任务总结，发送给双向机器人。
6. 双向机器人消息交互（参考 OpenClaw）
6.1 收到飞书用户消息后，立即对该消息添加 emoji reaction（如 👀）表示已收到正在处理。
6.2 消息写入 CLI stdin 并等待输出。
6.3 CLI 输出回复后，以消息卡片格式发送给用户，并移除 👀 reaction。
6.4 飞书消息仅提取纯文本写入 stdin，忽略图片/@提及/表情等非文本内容。
7. 推送消息格式与节流
7.1 推送消息使用富文本（post）格式，CLI 输出放入代码块。
7.2 发送前清洗 ANSI 转义码/颜色/光标控制符，保留纯文本。
7.3 消息合并窗口：每 2-3 秒合并一次输出为一条消息发送（Webhook 限制 5 QPS / 100 QPM）。
7.4 单条消息超过飞书限制（约 30KB）时截断，保留尾部最新内容。
7.5 过滤进度条、光标移动等无意义输出。
7.6 触发限流（错误码 11232）时自动增大合并窗口。

**非功能需求**
1. 跨平台支持 Windows 与 macOS（首版本可先支持 Windows）。
2. 代理不改变本地 CLI 交互体验。
3. 稳定性：Daemon 崩溃时 CLI 本地会话不受影响，仅飞书桥接中断；Daemon 重启后 CLI 可重新连接恢复桥接。
4. 安全性：机器人密钥本地加密存储。

**交互流程**
1. 用户在终端执行 `feishu run claude ...`。
2. 会话注册到本地守护进程并显示在 GUI。
3. 用户在 GUI 中选择会话并绑定双向机器人。
4. 可选绑定推送机器人并开启推送。
5. 飞书消息进入双向机器人，写入 CLI。
6. 过程输出推送给推送机器人。
7. 任务结束时发送总结给双向机器人。

**权限与安全**
1. 飞书交互机器人使用事件订阅长连接（WebSocket）模式，无需公网回调；认证在连接建立时完成，事件解密由 SDK 处理。
2. 本地密钥使用系统安全存储或加密文件（keytar 对接系统密钥链）。
3. IPC 使用 Unix Socket / Named Pipe，不监听网络端口，仅限本机进程访问。

**Daemon 生命周期**
1. 懒启动：CLI 或 GUI 启动时自动检测 Daemon 是否运行，未运行则自动后台拉起。
2. 服务发现：Daemon 启动后将 PID 和 IPC 地址写入锁文件 `~/.feishu-cli/daemon.json`，CLI/GUI 读取该文件连接 Daemon。
3. 防重复启动：启动前检查锁文件中的 PID 是否存活，存活则直接连接，PID 已死则清理锁文件并重新启动。
4. 优雅关闭：`feishu daemon stop` 通知所有已连接 CLI 断开飞书桥接，关闭飞书长连接，删除锁文件后退出。
5. CLI 子命令：`feishu daemon start`（手动启动）、`feishu daemon stop`（优雅关闭）、`feishu daemon status`（查看状态：PID、活跃会话数、飞书连接状态）。
6. 不做开机自启，用时自动拉起即可。

**IPC 与服务发现**
1. 通信通道：Daemon 监听 Unix Socket（macOS: `~/.feishu-cli/daemon.sock`）或 Named Pipe（Windows: `\\.\pipe\feishu-cli`），不占用 TCP 端口，不暴露网络。
2. 所有飞书通信均为 Daemon 出站连接（WebSocket 长连接 + Webhook POST），无需监听任何网络端口。
3. CLI 连接流程：读取锁文件 → 获取 IPC 地址 → WebSocket 连接 → 发送会话注册消息 → 开始双向流转发。
4. GUI 连接流程：读取锁文件 → 获取 IPC 地址 → HTTP REST 操作 + WebSocket 订阅实时状态。
5. 锁文件格式：
```json
// ~/.feishu-cli/daemon.json
{
  "pid": 12345,
  "ipc": "~/.feishu-cli/daemon.sock",
  "started_at": "2026-02-21T10:00:00Z"
}
```

**用户配置**
1. 配置文件路径：`~/.feishu-cli/config.json`。
2. 配置项：
```json
{
  "reconnect": {
    "max_retries": 3,
    "interval_ms": 5000,
    "backoff_multiplier": 2
  },
  "push": {
    "merge_window_ms": 2000,
    "max_message_bytes": 30000
  }
}
```

**飞书长连接接入细节（交互机器人）**
1. 应用与能力：在飞书开放平台创建企业应用，启用“机器人”能力并设置机器人信息。
2. 事件订阅：在“事件与回调”中选择“长连接”模式，并订阅消息事件 `im.message.receive_v1`。
3. 权限配置：按订阅事件与消息回复需求申请 IM 相关权限；常见权限包括 `im:message`、`im:message:send_as_bot`、`im:chat`，最终以控制台提示为准。
4. 凭证与密钥：保存 `App ID`/`App Secret`；如启用事件加密需配置 `Encrypt Key` 并在本地 SDK 中设置 `encryptKey`。
5. 本地连接方式：Daemon 使用飞书 SDK `WSClient` 建立 WebSocket 长连接，注册事件处理器并调用发送消息 API 回复。
6. 运行约束：无需公网回调，仅需出网；事件处理需在 3 秒内完成，否则触发重推；同一应用多实例部署时仅随机一个实例收到事件；长连接仅支持事件订阅，不支持回调订阅。
7. 断线重连：长连接断开后自动重试，重试次数用户可配置（默认 3 次），重试间隔支持指数退避（默认初始 5 秒，退避倍数 2，即 5s → 10s → 20s）。超过最大重试次数后停止重连并通知用户（GUI 提示 + 系统通知）。

**技术选型**

| 层 | 技术 | 说明 |
|---|---|---|
| CLI | TypeScript / Node.js + commander + node-pty | PTY 宿主进程，持有 PTY 并转发输出流给 Daemon |
| Daemon | TypeScript / Node.js | 轻量协调服务：飞书连接、消息路由、会话注册、存储（不持有 PTY） |
| GUI | Tauri (Rust) + Web 前端 (TypeScript) | 轻量桌面端，Tray 常驻 + 窗口管理 |
| IPC (CLI↔Daemon) | Unix Socket (macOS) / Named Pipe (Windows) + WebSocket | 无端口冲突，不暴露网络 |
| IPC (GUI↔Daemon) | 同上，HTTP REST + WebSocket | REST 做操作，WS 推送实时状态 |
| 飞书交互机器人 | 飞书事件订阅（WebSocket 长连接） | Daemon 内嵌长连接客户端接收飞书事件（无需公网回调） |
| 飞书推送机器人 | Webhook POST | 单向推送消息 |
| 密钥存储 | keytar | Windows Credential Vault / macOS Keychain |
| 构建打包 | Tauri (GUI) + esbuild (CLI/Daemon) | |
| 项目管理 | pnpm workspace monorepo | 拆分 cli / daemon / gui / shared |

**项目结构**
```
feishu-cli/
├── packages/
│   ├── shared/            # 共享类型、常量、工具函数 (TypeScript)
│   ├── cli/               # feishu 命令行入口 (TypeScript + node-pty)
│   │   └── src/
│   │       ├── pty/           # PTY 创建与管理
│   │       ├── bridge/        # 与 Daemon 的连接与输出转发
│   │       └── terminal/      # 本地终端 I/O 中继
│   ├── daemon/            # 后台协调服务 (TypeScript)
│   │   └── src/
│   │       ├── session/       # 会话注册表
│   │       ├── feishu/        # 飞书 API 封装 (长连接 + Webhook)
│   │       ├── router/        # 消息路由
│   │       ├── summarizer/    # 任务总结
│   │       ├── storage/       # 加密存储
│   │       └── server/        # HTTP + WS 服务
│   └── gui/               # Tauri 桌面端
│       ├── src-tauri/         # Rust 后端 (tray、窗口、系统通知)
│       └── src/               # Web 前端 (TypeScript + Vue/React)
├── pnpm-workspace.yaml
├── tsconfig.base.json
└── package.json
```

**架构概览**
```
┌──────────────────────────────────┐
│         Tauri GUI (Rust)          │
│  ┌────────────┐  ┌────────────┐  │
│  │ Rust 后端   │  │ Web 前端    │  │
│  │ - Tray 管理 │  │ - Vue/React │  │
│  │ - 窗口管理  │  │ - 会话列表  │  │
│  │ - 系统通知  │  │ - 机器人配置│  │
│  └──────┬─────┘  └────────────┘  │
│         │ Unix Socket / Named Pipe │
└─────────┼────────────────────────┘
          ▼
┌──────────────────────────────────┐
│    Daemon (Node.js, 轻量协调者)    │
│  - 飞书长连接 (WSClient, 出站)   │
│  - 消息路由                       │
│  - 会话注册表                     │
│  - 加密存储                       │
│  - 无网络端口监听                  │
└──────────────────────────────────┘
          ▲
          │ Unix Socket / Named Pipe
┌─────────┴────────────────────────┐
│    CLI (Node.js, PTY 宿主)        │
│  feishu run claude ...            │
│  - 创建并持有 PTY (node-pty)     │
│  - 本地终端 I/O                   │
│  - 输出流转发给 Daemon            │
│  - 接收 Daemon 转发的飞书输入     │
│                                   │
│  关闭终端 = 会话结束               │
└──────────────────────────────────┘
```

**界面设计**

整体风格：紧凑型工具窗口（约 640x480），左侧标签导航 + 右侧内容面板。Tray 常驻，点击托盘图标弹出主面板。

1. 系统托盘菜单
```
┌───────────────────────┐
│  Feishu CLI Proxy      │
├───────────────────────┤
│  打开面板              │
│  活跃会话: 2           │
├───────────────────────┤
│  Daemon: 运行中        │
│  停止 Daemon           │
├───────────────────────┤
│  退出                  │
└───────────────────────┘
```
托盘图标颜色指示状态：绿色 = Daemon 运行中且有活跃会话；灰色 = Daemon 未运行或无会话。

2. 主面板 — 会话列表页
```
┌──────────────────────────────────────────────────────┐
│  Feishu CLI Proxy                         ─  □  ✕   │
├─────────┬────────────────────────────────────────────┤
│         │  会话详情                                    │
│  导航    │ ┌──────────────────────────────────────────┐│
│         ││ claude : project-foo               🟢 代理中││
│ 📋 会话  ││ ─────────────────────────────────────────  ││
│         ││                                            ││
│ 🤖 机器人││ 双向机器人                                  ││
│         ││ ┌──────────────────────────────────┐       ││
│ ⚙ 设置  ││ │ interactive-A             ▼     │       ││
│         ││ └──────────────────────────────────┘       ││
│         ││     [ 绑定 ]   [ 解绑 ]                    ││
│ ──────  ││                                            ││
│ 会话列表 ││ 推送机器人                                  ││
│         ││ ┌──────────────────────────────────┐       ││
│ 🟢 s-123││ │ push-A                    ▼     │       ││
│ claude  ││ └──────────────────────────────────┘       ││
│ proj-foo││     [ ✅ 启用推送 ]                         ││
│         ││                                            ││
│ 🟡 s-456││ ─────────────────────────────────────────  ││
│ codex   ││ 会话信息                                    ││
│ proj-bar││ 命令:  claude --project foo                 ││
│         ││ 目录:  ~/projects/foo                       ││
│         ││ 启动:  2026-02-21 10:30                    ││
│         ││ 状态:  proxy_on                             ││
│         ││ PID:   28456                                ││
│         │└──────────────────────────────────────────┘│
├─────────┴────────────────────────────────────────────┤
│  Daemon: 运行中 (PID 12345)      会话: 2 活跃         │
└──────────────────────────────────────────────────────┘
```
会话列表项状态指示：🟢 = proxy_on（代理中）；🟡 = listening（监听中）；⚫ = ended（已结束）。
选中会话高亮显示，右侧展示详情和操作按钮。
无会话时右侧显示空状态提示："在终端中执行 feishu run claude ... 启动会话"。

3. 主面板 — 机器人配置页
```
┌──────────────────────────────────────────────────────┐
│  Feishu CLI Proxy                         ─  □  ✕   │
├─────────┬────────────────────────────────────────────┤
│         │  机器人配置                                  │
│  导航    │                                             │
│         │  双向机器人（交互）                            │
│ 📋 会话  │ ┌────────────────────────────────────────┐  │
│         │ │  interactive-A                          │  │
│ 🤖 机器人│ │  App ID: cli_a3f8***        🟢 已连接   │  │
│         │ │                     [ 编辑 ]  [ 删除 ]  │  │
│ ⚙ 设置  │ ├────────────────────────────────────────┤  │
│         │ │  interactive-B                          │  │
│         │ │  App ID: cli_b72e***        ⚫ 未连接   │  │
│         │ │                     [ 编辑 ]  [ 删除 ]  │  │
│         │ └────────────────────────────────────────┘  │
│         │                         [ + 添加双向机器人 ] │
│         │                                             │
│         │  推送机器人（Webhook）                        │
│         │ ┌────────────────────────────────────────┐  │
│         │ │  push-A                                │  │
│         │ │  Webhook: https://open.f***            │  │
│         │ │                     [ 编辑 ]  [ 删除 ]  │  │
│         │ └────────────────────────────────────────┘  │
│         │                         [ + 添加推送机器人 ] │
│         │                                             │
├─────────┴────────────────────────────────────────────┤
│  Daemon: 运行中 (PID 12345)      会话: 2 活跃         │
└──────────────────────────────────────────────────────┘
```
双向机器人显示连接状态：🟢 已连接（长连接正常）；🔴 连接断开（重试中）；⚫ 未连接（未启用）。
推送机器人无连接状态（Webhook 是无状态的，只显示配置信息）。

4. 弹窗 — 添加双向机器人
```
┌──────────────────────────────────────┐
│  添加双向机器人                    ✕  │
├──────────────────────────────────────┤
│                                      │
│  名称 *                              │
│  ┌──────────────────────────────┐    │
│  │ 如: my-bot                   │    │
│  └──────────────────────────────┘    │
│                                      │
│  App ID *                            │
│  ┌──────────────────────────────┐    │
│  │                              │    │
│  └──────────────────────────────┘    │
│                                      │
│  App Secret *                        │
│  ┌──────────────────────────────┐    │
│  │ ●●●●●●●●●●●●            👁   │    │
│  └──────────────────────────────┘    │
│                                      │
│  Encrypt Key（可选）                  │
│  ┌──────────────────────────────┐    │
│  │                              │    │
│  └──────────────────────────────┘    │
│  启用事件加密时填写                    │
│                                      │
│  [ 测试连接 ]                        │
│  ┌──────────────────────────────┐    │
│  │ ✅ 连接成功，机器人名: xxx     │    │
│  └──────────────────────────────┘    │
│                                      │
│          [ 取消 ]    [ 保存 ]        │
│                                      │
└──────────────────────────────────────┘
```
必填项标 *；App Secret 默认遮掩，点击 👁 切换可见。
[ 测试连接 ] 按钮使用填入的凭证尝试建立飞书长连接，成功后显示机器人名称确认身份，失败显示错误原因。
保存时凭证写入系统密钥链（keytar）。

5. 弹窗 — 添加推送机器人
```
┌──────────────────────────────────────┐
│  添加推送机器人                    ✕  │
├──────────────────────────────────────┤
│                                      │
│  名称 *                              │
│  ┌──────────────────────────────┐    │
│  │ 如: my-push-bot              │    │
│  └──────────────────────────────┘    │
│                                      │
│  Webhook 地址 *                      │
│  ┌──────────────────────────────┐    │
│  │ https://open.feishu.cn/...   │    │
│  └──────────────────────────────┘    │
│                                      │
│  签名校验密钥（可选）                  │
│  ┌──────────────────────────────┐    │
│  │ ●●●●●●●●●●●●            👁   │    │
│  └──────────────────────────────┘    │
│  在飞书群机器人安全设置中获取          │
│                                      │
│  [ 发送测试消息 ]                    │
│  ┌──────────────────────────────┐    │
│  │ ✅ 发送成功                   │    │
│  └──────────────────────────────┘    │
│                                      │
│          [ 取消 ]    [ 保存 ]        │
│                                      │
└──────────────────────────────────────┘
```
[ 发送测试消息 ] 向 Webhook 地址 POST 一条 "[Feishu CLI Proxy] 测试消息" 验证地址有效性。

6. 弹窗 — 编辑机器人
```
┌──────────────────────────────────────┐
│  编辑双向机器人: interactive-A     ✕  │
├──────────────────────────────────────┤
│                                      │
│  （与添加弹窗相同的表单，预填当前值）    │
│  名称、App ID 不可修改（灰色只读）     │
│  App Secret、Encrypt Key 可更新       │
│                                      │
│  [ 测试连接 ]                        │
│                                      │
│          [ 取消 ]    [ 保存 ]        │
│                                      │
└──────────────────────────────────────┘
```
App ID 作为唯一标识不可修改；如需更换 App ID 应删除后重新添加。

7. 弹窗 — 删除确认
```
┌──────────────────────────────────────┐
│  删除机器人                        ✕  │
├──────────────────────────────────────┤
│                                      │
│  确定删除机器人 "interactive-A" 吗？  │
│                                      │
│  该机器人当前绑定了 1 个活跃会话，     │
│  删除后这些会话的代理将自动断开。      │
│                                      │
│          [ 取消 ]    [ 删除 ]        │
│                                      │
└──────────────────────────────────────┘
```
[ 删除 ] 按钮红色高亮警示。
如果机器人绑定了活跃会话，弹窗中明确提示影响范围。

8. 主面板 — 设置页
```
┌──────────────────────────────────────────────────────┐
│  Feishu CLI Proxy                         ─  □  ✕   │
├─────────┬────────────────────────────────────────────┤
│         │  设置                                       │
│  导航    │                                             │
│         │  飞书长连接                                   │
│ 📋 会话  │  重试次数        ┌──────┐                    │
│         │                 │ 3    │                    │
│ 🤖 机器人│                  └──────┘                    │
│         │  初始重试间隔(秒)  ┌──────┐                   │
│ ⚙ 设置  │                 │ 5    │                    │
│         │                  └──────┘                    │
│         │  退避倍数         ┌──────┐                   │
│         │                 │ 2    │                    │
│         │                  └──────┘                    │
│         │                                             │
│         │  推送消息                                    │
│         │  合并窗口(毫秒)   ┌──────┐                   │
│         │                 │ 2000 │                    │
│         │                  └──────┘                    │
│         │  单条消息上限(字节)┌──────┐                   │
│         │                 │ 30000│                    │
│         │                  └──────┘                    │
│         │                                             │
│         │                  [ 恢复默认 ]  [ 保存 ]      │
│         │                                             │
├─────────┴────────────────────────────────────────────┤
│  Daemon: 运行中 (PID 12345)      会话: 2 活跃         │
└──────────────────────────────────────────────────────┘
```
修改配置后保存到 `~/.feishu-cli/config.json`，需要重启 Daemon 生效的配置项在旁边标注提示。

**依赖与集成**
1. PTY 库：node-pty（Windows conpty / macOS 兼容，VS Code 同款）。
2. 飞书机器人 API（事件订阅长连接模式）。
3. GUI 框架：Tauri 2.x（Rust 后端 + 系统 WebView 渲染）。
4. 密钥管理：keytar（系统密钥链）。

**风险**
1. 某些 CLI 对 PTY 行为敏感，需要兼容验证。
2. 飞书消息频率限制影响高频推送（需做消息合并/节流）。
3. 长连接模式下，同一应用多实例部署时只会有一个实例收到事件。
4. Tauri WebView2 在少数旧版 Windows 10 上需手动安装。

**里程碑**
1. M1：项目脚手架搭建 + CLI 启动 PTY + 会话注册到 Daemon。
2. M2：Tauri GUI 会话列表 + 机器人配置 + 绑定操作。
3. M3：飞书双向对话与过程推送。
4. M4：任务结束总结与稳定性优化。

**已决议的开放问题**
1. ~~任务结束判定使用 Hook/MCP 还是 CLI 退出事件？~~ → 优先 CLI 退出事件，辅助 hooks 增强。
2. ~~总结是否需要独立模型生成，还是复用 CLI 输出？~~ → 复用 CLI 最后输出，不额外调模型。
3. ~~是否允许一个推送机器人绑定多个会话？~~ → 允许，消息携带会话标识区分。
